<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="https://api.fontshare.com/v2/css?f[]=clash-display@400,700,500,600&display=swap">
    <style>
        body {
            font-family: 'Clash Display', sans-serif;
        }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; padding-bottom: calc(7 * (100vw / 7 + 5px) + 80px); }
        .number-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 5px;
            background: white;
        }
        .number-btn, .control-btn {
            padding: 15px;
            font-size: 16px;
            cursor: pointer;
            border: 1px solid #ccc;
            background: white;
        }

        .control-btn-back {  padding: 15px;
            font-size: 16px;
            cursor: pointer;
            border: 1px solid #ccc;
            color: white;
        background-color: rgb(63, 146, 255); 
    }
        .selected { background-color: #4CAF50; color: white; }
        .active-multiplier { background-color: #c8c8c870 !important; color: rgb(0, 0, 0)!important; }
        .controls { margin: 20px 0; }
        .throws {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        .throw {
            padding: 10px;
            border: 1px solid #ccc;
            min-width: 100px;
            text-align: center;
        }
        .throw-total {
            padding: 15px;
            border: 1px solid #ccc;
            min-width: 150px;
            text-align: center;
            margin: 20px 0;
            font-size: 18px;
            display: none;
        }
        .score { 
            font-size: 48px; 
            margin: 20px 0; 
            font-weight: bold;
        }
        .stats {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            font-size: 18px;
        }
        .input-area {
            margin: 20px 0;
            display: flex;
            gap: 10px;
        }
        #manualInput {
            padding: 10px;
            font-size: 16px;
            width: 100px;
        }
        .voice-total-active .throws { display: none; }
        .voice-total-active .throw-total { display: block; }
        .voice-btn-active { background-color: #4CAF50; color: white; }
        .active-throw {
            border: 2px solid #4CAF50;
            background-color: #9dd19e;
        }
        .multiplier-btn {
            grid-column: span 7;
            margin-bottom: 5px;
        }
        #doubleBtn {
            color: white;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2px;
            border: 1px solid rgb(245, 190, 88);
            background-color: rgb(255, 166, 2);
            grid-column: 1 / 4;
        }
        #tripleBtn {
            color: white;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2px;
            border: 1px solid rgb(245, 88, 88);
            background-color: rgb(255, 2, 2);
            grid-column: 4 / 8;
        }
        .undo-btn {
            grid-column: span 7;
            margin-top: 5px;
        }
        .number-btn:disabled {
            pointer-events: none;
            background-color: #f0f0f0;
        }
        .error-banner {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 68, 68, 0.95);
            color: white;
            display: none;
            z-index: 1000;
            text-align: center;
            font-size: 24px;
            padding: 20px 40px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            min-width: 300px;
            max-width: 80%;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
</head>
<body>
    <div id="errorBanner" class="error-banner"></div>
    <div class="container">
        <div class="score"><span id="currentScore">501</span></div>
        <div class="stats">
            <div>Kolo: <span id="roundCounter">1</span></div>
            <div>Celkem šipek: <span id="totalDarts">0</span></div>
        </div>
        <div class="stats">
            <div>Průměr na 3 šipky: <span id="avgPerThree">0.00</span></div>
            <div>Průměr prvních 9: <span id="avgFirstNine">0.00</span></div>
        </div>
        <div class="throws">
            <div class="throw" id="throw1">-</div>
            <div class="throw" id="throw2">-</div>
            <div class="throw" id="throw3">-</div>
        </div>
        <div class="throw-total" id="throwTotal">-</div>
        <div class="input-area">
            <input type="number" id="manualInput" placeholder="Zadej body">
            <button onclick="addManualScore()" class="control-btn">Přidat</button>
        </div>
        <div class="controls">
            <button id="voiceTotalBtn" class="control-btn">🎤 Hlasový vstup - celkem</button>
            <button id="voicePerThrowBtn" class="control-btn">🎤 Hlasový vstup - jednotlivě</button>
            <button onclick="resetGame()" class="control-btn">🔄 Reset</button>
        </div>
        <div id="numberGrid" class="number-grid">
            <button onclick="toggleMultiplier(2)" id="doubleBtn" class="control-btn multiplier-btn">Double</button>
            <button onclick="toggleMultiplier(3)" id="tripleBtn" class="control-btn multiplier-btn">Triple</button>
        </div>
    </div>

    <script>
        let currentScore = 501;
        let throws = [];
        let history = [{score: 501, throws: []}];
        let activeMultiplier = 1;
        let currentRound = 1;
        let totalDarts = 0;
        let voiceMode = 'none'; // 'none', 'total', 'perThrow'
        let recognition = null;
        let currentThrowIndex = 0;
        const maxThrows = 3;

        function convertSpokenNumberToCzech(text) {
            const numberWords = {
                'nula': 0, 'jedna': 1, 'dvě': 2, 'tři': 3, 'čtyři': 4,
                'pět': 5, 'šest': 6, 'sedm': 7, 'osm': 8, 'devět': 9,
                'deset': 10, 'jedenáct': 11, 'dvanáct': 12, 'třináct': 13,
                'čtrnáct': 14, 'patnáct': 15, 'šestnáct': 16, 'sedmnáct': 17,
                'osmnáct': 18, 'devatenáct': 19, 'dvacet': 20
            };

            text = text.toLowerCase().trim();
            
            if (text === 'zpět' || text === 'zpet') {
                return 'undo';
            }
            
            if (numberWords.hasOwnProperty(text)) {
                return numberWords[text];
            }
            
            const numericValue = parseInt(text.replace(/\D/g, ''));
            if (!isNaN(numericValue)) {
                return numericValue;
            }
            
            return null;
        }

        function addManualScore() {
            const input = document.getElementById('manualInput');
            const value = parseInt(input.value);
            if (!isNaN(value) && value >= 0) {
                if (voiceMode === 'total') {
                    addVoiceTotal(value);
                } else {
                    addScore(value);
                }
                input.value = '';
            }
        }

        document.getElementById('manualInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addManualScore();
            }
        });

        function addScore(points) {
            if (points > 60) {
                showErrorBanner('Nelze hodit více než 60 bodů jednou šipkou!');
                if (recognition) {
                    setTimeout(() => {
                        recognition.start();
                    }, 1000);
                }
                return;
            }
            
            if (throws.length >= maxThrows) return;
            
            currentScore -= points;
            throws.push({
                base: points,
                multiplier: 1,
                points: points
            });
            totalDarts++;
            saveState();
            updateDisplay();
            
            if (currentThrowIndex < maxThrows - 1) {
                currentThrowIndex++;
                updateThrowIndicators();
            }
            
            if (throws.length >= maxThrows) {
                setTimeout(() => {
                    throws = [];
                    currentRound++;
                    currentThrowIndex = 0;
                    saveState();
                    updateDisplay();
                    updateThrowIndicators();
                }, 2000);
            }
        }

        function showErrorBanner(message) {
            const banner = document.getElementById('errorBanner');
            banner.textContent = message;
            banner.style.display = 'block';
            setTimeout(() => {
                banner.style.display = 'none';
            }, 3000);
        }

        function addVoiceTotal(points) {
            if (points > 180) {
                showErrorBanner('Nelze hodit více než 180 bodů na tři šipky!');
                if (recognition) {
                    setTimeout(() => {
                        recognition.start();
                    }, 1000);
                }
                return;
            }
            
            currentScore -= points;
            totalDarts += 3;
            history.push({
                score: currentScore,
                voiceTotal: points,
                round: currentRound,
                totalDarts: totalDarts
            });
            updateDisplay();
            
            setTimeout(() => {
                currentRound++;
                throws = [];
                history.push({
                    score: currentScore,
                    voiceTotal: null,
                    round: currentRound,
                    totalDarts: totalDarts
                });
                updateDisplay();
                if (voiceMode === 'total' && recognition) {
                    recognition.start();
                }
            }, 2000);
        }

        function updateThrowIndicators() {
            for (let i = 1; i <= maxThrows; i++) {
                const throwElement = document.getElementById(`throw${i}`);
                if (i - 1 === currentThrowIndex) {
                    throwElement.classList.add('current-throw-indicator');
                    throwElement.classList.add('active-throw');
                } else {
                    throwElement.classList.remove('current-throw-indicator');
                    throwElement.classList.remove('active-throw');
                }
            }
        }

        function calculateAverages() {
            if (totalDarts === 0) return { avgPerThree: 0, avgFirstNine: 0 };
            
            // Výpočet průměru na 3 šipky
            const totalScore = 501 - currentScore;
            const avgPerThree = (totalScore / totalDarts) * 3;
            
            // Výpočet průměru prvních 9 šipek
            let firstNineScore = 0;
            if (totalDarts >= 9) {
                firstNineScore = 501 - history[Math.min(3, history.length - 1)].score;
            } else {
                firstNineScore = 501 - currentScore;
            }
            const avgFirstNine = totalDarts >= 9 ? (firstNineScore / 9) * 3 : 0;
            
            return {
                avgPerThree: Math.round(avgPerThree * 100) / 100,
                avgFirstNine: Math.round(avgFirstNine * 100) / 100
            };
        }

        function updateDisplay() {
            // Animace skóre pomocí GSAP
            gsap.to("#currentScore", {
                duration: 0.5,
                innerText: currentScore,
                snap: { innerText: 1 },
                ease: "power2.out"
            });
            
            document.getElementById('roundCounter').textContent = currentRound;
            document.getElementById('totalDarts').textContent = totalDarts;
            
            // Přidáno: Aktualizace průměrů
            const averages = calculateAverages();
            document.getElementById('avgPerThree').textContent = averages.avgPerThree;
            document.getElementById('avgFirstNine').textContent = averages.avgFirstNine;
            
            if (voiceMode === 'total') {
                const lastState = history[history.length - 1];
                document.getElementById('throwTotal').textContent = 
                    lastState.voiceTotal !== null ? `${lastState.voiceTotal}` : '-';
            } else {
                for (let i = 1; i <= maxThrows; i++) {
                    const throwElement = document.getElementById(`throw${i}`);
                    const throwValue = throws[i-1];
                    throwElement.textContent = throwValue ? 
                        `${throwValue.points} (${throwValue.base}×${throwValue.multiplier})` : 
                        '-';
                }
            }
            updateThrowIndicators();
        }

        function saveState() {
            history.push({
                score: currentScore,
                throws: [...throws],
                round: currentRound,
                totalDarts: totalDarts
            });
        }

        function toggleMultiplier(value) {
            if (voiceMode === 'none') {
                activeMultiplier = activeMultiplier === value ? 1 : value;
                document.getElementById('doubleBtn').classList.toggle('active-multiplier', activeMultiplier === 2);
                document.getElementById('tripleBtn').classList.toggle('active-multiplier', activeMultiplier === 3);
                
                // Úprava: Deaktivace tlačítek pro nulu a 25 při triple
                const zeroButton = document.querySelector('.number-btn[data-value="0"]');
                const bull25Button = document.querySelector('.number-btn[data-value="25"]');
                
                if (zeroButton) {
                    zeroButton.disabled = activeMultiplier !== 1;
                    zeroButton.style.opacity = activeMultiplier === 1 ? '1' : '0.5';
                    zeroButton.style.cursor = activeMultiplier === 1 ? 'pointer' : 'not-allowed';
                }
                
                if (bull25Button) {
                    bull25Button.disabled = activeMultiplier === 3;
                    bull25Button.style.opacity = activeMultiplier === 3 ? '0.5' : '1';
                    bull25Button.style.cursor = activeMultiplier === 3 ? 'not-allowed' : 'pointer';
                }
            }
        }

        function selectNumber(num) {
            if (voiceMode !== 'none') return;
            if (throws.length >= maxThrows) return;
            
            const points = num * activeMultiplier;
            throws.push({
                base: num,
                multiplier: activeMultiplier,
                points: points
            });
            currentScore -= points;
            totalDarts++;
            saveState();
            
            if (currentThrowIndex < maxThrows - 1) {
                currentThrowIndex++;
            }
            updateDisplay();
            updateThrowIndicators();
            
            if (activeMultiplier !== 1) {
                toggleMultiplier(activeMultiplier);
            }
            
            if (throws.length >= maxThrows) {
                setTimeout(() => {
                    throws = [];
                    currentRound++;
                    currentThrowIndex = 0;
                    saveState();
                    updateDisplay();
                    updateThrowIndicators();
                }, 2000);
            }
        }

        function undoLastThrow() {
            if (history.length > 1) {
                history.pop();
                const lastState = history[history.length - 1];
                currentScore = lastState.score;
                throws = lastState.throws ? [...lastState.throws] : [];
                currentRound = lastState.round;
                totalDarts = lastState.totalDarts;
                
                // Přidaná kontrola - pokud se vrátíme na 501, resetujeme statistiky
                if (currentScore === 501) {
                    currentRound = 1;
                    totalDarts = 0;
                    history = [{score: 501, throws: []}];
                }
                
                currentThrowIndex = throws.length;
                updateDisplay();
                updateThrowIndicators();
            }
        }

        function resetGame() {
            currentScore = 501;
            throws = [];
            history = [{score: 501, throws: []}];
            activeMultiplier = 1;
            currentRound = 1;
            totalDarts = 0;
            currentThrowIndex = 0;
            setVoiceMode('none');
            toggleMultiplier(1);
            updateDisplay();
            updateThrowIndicators();
        }

        function setVoiceMode(mode) {
            voiceMode = mode;
            const container = document.querySelector('.container');
            const voiceTotalBtn = document.getElementById('voiceTotalBtn');
            const voicePerThrowBtn = document.getElementById('voicePerThrowBtn');
            
            container.classList.toggle('voice-total-active', mode === 'total');
            voiceTotalBtn.classList.toggle('voice-btn-active', mode === 'total');
            voicePerThrowBtn.classList.toggle('voice-btn-active', mode === 'perThrow');
            
            if (recognition) {
                recognition.stop();
                if (mode !== 'none') {
                    recognition.start();
                }
            }
            
            currentThrowIndex = 0;
            updateDisplay();
        }

        const numberGrid = document.getElementById('numberGrid');
        const numbers = [...Array(20).keys()].map(i => i + 1);
        numbers.push(25, 0);
        for (const i of numbers) {
            const btn = document.createElement('button');
            btn.textContent = i;
            btn.className = 'number-btn';
            btn.setAttribute('data-value', i);
            btn.onclick = () => selectNumber(i);
            numberGrid.appendChild(btn);
            
            // Přidání tlačítka Zpět hned za nulu
            if (i === 0) {
                const undoBtn = document.createElement('button');
                undoBtn.textContent = '↩️ Zpět';
                undoBtn.className = 'control-btn-back';
                undoBtn.onclick = undoLastThrow;
                undoBtn.style.gridColumn = 'span 6'; // Roztáhne se přes zbývající sloupce
                numberGrid.appendChild(undoBtn);
            }
        }

        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            
            recognition.lang = 'cs-CZ';
            recognition.continuous = true;
            recognition.interimResults = true;
            
            let processingTimeout = null;
            let isProcessing = false;
            
            recognition.onresult = function(event) {
                if (isProcessing) return;
                
                clearTimeout(processingTimeout);
                const transcript = event.results[event.results.length - 1][0].transcript;
                console.log('Průběžný text:', transcript);
                
                processingTimeout = setTimeout(() => {
                    if (isProcessing) return;
                    isProcessing = true;
                    
                    console.log('Finální text:', transcript);
                    const result = convertSpokenNumberToCzech(transcript);
                    
                    if (result === 'undo') {
                        recognition.stop();
                        undoLastThrow();
                        // Restartujeme rozpoznávání po krátké pauze
                        setTimeout(() => {
                            isProcessing = false;
                            if (voiceMode !== 'none') {
                                recognition.start();
                            }
                        }, 2000);
                    } else if (result !== null) {
                        console.log('Odečítám:', result, 'od:', currentScore);
                        recognition.stop();
                        
                        if (voiceMode === 'total') {
                            addVoiceTotal(result);
                        } else if (voiceMode === 'perThrow') {
                            addScore(result);
                        }
                        
                        setTimeout(() => {
                            isProcessing = false;
                            if (voiceMode !== 'none') {
                                recognition.start();
                            }
                        }, 2000);
                    } else {
                        isProcessing = false;
                    }
                }, 1500);
            };

            recognition.onend = function() {
                // Only auto-restart if we're not in the middle of processing a number
                if (voiceMode !== 'none' && !isProcessing) {
                    setTimeout(() => {
                        recognition.start();
                    }, 100);
                }
            };

            document.getElementById('voiceTotalBtn').onclick = () => {
                setVoiceMode(voiceMode === 'total' ? 'none' : 'total');
            };
            
            document.getElementById('voicePerThrowBtn').onclick = () => {
                setVoiceMode(voiceMode === 'perThrow' ? 'none' : 'perThrow');
            };

        } else {
            console.log("Hlasové rozpoznávání není podporováno");
            document.getElementById('voiceTotalBtn').style.display = 'none';
            document.getElementById('voicePerThrowBtn').style.display = 'none';
        }

        resetGame();
    </script>
</body>
</html>