<!DOCTYPE html>
<html>
<head>
    <style>
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .number-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
            margin: 20px 0;
        }
        .number-btn, .control-btn {
            padding: 15px;
            font-size: 16px;
            cursor: pointer;
            border: 1px solid #ccc;
            background: white;
        }
        .selected { background-color: #4CAF50; color: white; }
        .active-multiplier { background-color: #ff4444; color: white; }
        .controls { margin: 20px 0; }
        .throws {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        .throw {
            padding: 10px;
            border: 1px solid #ccc;
            min-width: 100px;
            text-align: center;
        }
        .throw-total {
            padding: 15px;
            border: 1px solid #ccc;
            min-width: 150px;
            text-align: center;
            margin: 20px 0;
            font-size: 18px;
            display: none;
        }
        .score { font-size: 24px; margin: 20px 0; }
        .stats {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            font-size: 18px;
        }
        .input-area {
            margin: 20px 0;
            display: flex;
            gap: 10px;
        }
        #manualInput {
            padding: 10px;
            font-size: 16px;
            width: 100px;
        }
        .voice-total-active .throws { display: none; }
        .voice-total-active .throw-total { display: block; }
        .voice-btn-active { background-color: #4CAF50; color: white; }
        .active-throw {
            border: 2px solid #4CAF50;
            background-color: #9dd19e;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="score">Score: <span id="currentScore">501</span></div>
        <div class="stats">
            <div>Kolo: <span id="roundCounter">1</span></div>
            <div>Celkem ≈°ipek: <span id="totalDarts">0</span></div>
        </div>
        <div class="stats">
            <div>Pr≈Ømƒõr na 3 ≈°ipky: <span id="avgPerThree">0.00</span></div>
            <div>Pr≈Ømƒõr prvn√≠ch 9: <span id="avgFirstNine">0.00</span></div>
        </div>
        <div class="throws">
            <div class="throw" id="throw1">-</div>
            <div class="throw" id="throw2">-</div>
            <div class="throw" id="throw3">-</div>
        </div>
        <div class="throw-total" id="throwTotal">-</div>
        <div class="input-area">
            <input type="number" id="manualInput" placeholder="Zadej body">
            <button onclick="addManualScore()" class="control-btn">P≈ôidat</button>
        </div>
        <div class="controls">
            <button id="voiceTotalBtn" class="control-btn">üé§ Hlasov√Ω vstup - celkem</button>
            <button id="voicePerThrowBtn" class="control-btn">üé§ Hlasov√Ω vstup - jednotlivƒõ</button>
            <button onclick="toggleMultiplier(2)" id="doubleBtn" class="control-btn">Double</button>
            <button onclick="toggleMultiplier(3)" id="tripleBtn" class="control-btn">Triple</button>
            <button onclick="undoLastThrow()" class="control-btn">‚Ü©Ô∏è Zpƒõt</button>
            <button onclick="resetGame()" class="control-btn">üîÑ Reset</button>
        </div>
        <div id="numberGrid" class="number-grid"></div>
    </div>

    <script>
        let currentScore = 501;
        let throws = [];
        let history = [{score: 501, throws: []}];
        let activeMultiplier = 1;
        let currentRound = 1;
        let totalDarts = 0;
        let voiceMode = 'none'; // 'none', 'total', 'perThrow'
        let recognition = null;
        let currentThrowIndex = 0;
        const maxThrows = 3;

        function convertSpokenNumberToCzech(text) {
            const numberWords = {
                'nula': 0, 'jedna': 1, 'dvƒõ': 2, 't≈ôi': 3, 'ƒçty≈ôi': 4,
                'pƒõt': 5, '≈°est': 6, 'sedm': 7, 'osm': 8, 'devƒõt': 9,
                'deset': 10, 'jeden√°ct': 11, 'dvan√°ct': 12, 't≈ôin√°ct': 13,
                'ƒçtrn√°ct': 14, 'patn√°ct': 15, '≈°estn√°ct': 16, 'sedmn√°ct': 17,
                'osmn√°ct': 18, 'devaten√°ct': 19, 'dvacet': 20
            };

            text = text.toLowerCase().trim();
            
            if (numberWords.hasOwnProperty(text)) {
                return numberWords[text];
            }
            
            const numericValue = parseInt(text.replace(/\D/g, ''));
            if (!isNaN(numericValue)) {
                return numericValue;
            }
            
            return null;
        }

        function addManualScore() {
            const input = document.getElementById('manualInput');
            const value = parseInt(input.value);
            if (!isNaN(value) && value >= 0) {
                if (voiceMode === 'total') {
                    addVoiceTotal(value);
                } else {
                    addScore(value);
                }
                input.value = '';
            }
        }

        document.getElementById('manualInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addManualScore();
            }
        });

        function addScore(points) {
            if (throws.length >= maxThrows) return;
            
            currentScore -= points;
            throws.push({
                base: points,
                multiplier: 1,
                points: points
            });
            totalDarts++;
            saveState();
            updateDisplay();
            
            if (currentThrowIndex < maxThrows - 1) {
                currentThrowIndex++;
                updateThrowIndicators();
            }
            
            if (throws.length >= maxThrows) {
                setTimeout(() => {
                    throws = [];
                    currentRound++;
                    currentThrowIndex = 0;
                    saveState();
                    updateDisplay();
                    updateThrowIndicators();
                }, 2000);
            }
        }

        function addVoiceTotal(points) {
            currentScore -= points;
            totalDarts += 3;
            history.push({
                score: currentScore,
                voiceTotal: points,
                round: currentRound,
                totalDarts: totalDarts
            });
            updateDisplay();
            
            setTimeout(() => {
                currentRound++;
                throws = [];
                history.push({
                    score: currentScore,
                    voiceTotal: null,
                    round: currentRound,
                    totalDarts: totalDarts
                });
                updateDisplay();
                if (voiceMode === 'total' && recognition) {
                    recognition.start();
                }
            }, 2000);
        }

        function updateThrowIndicators() {
            for (let i = 1; i <= maxThrows; i++) {
                const throwElement = document.getElementById(`throw${i}`);
                if (i - 1 === currentThrowIndex) {
                    throwElement.classList.add('current-throw-indicator');
                    throwElement.classList.add('active-throw');
                } else {
                    throwElement.classList.remove('current-throw-indicator');
                    throwElement.classList.remove('active-throw');
                }
            }
        }

        function calculateAverages() {
            if (totalDarts === 0) return { avgPerThree: 0, avgFirstNine: 0 };
            
            // V√Ωpoƒçet pr≈Ømƒõru na 3 ≈°ipky
            const totalScore = 501 - currentScore;
            const avgPerThree = (totalScore / totalDarts) * 3;
            
            // V√Ωpoƒçet pr≈Ømƒõru prvn√≠ch 9 ≈°ipek
            let firstNineScore = 0;
            if (totalDarts >= 9) {
                firstNineScore = 501 - history[Math.min(3, history.length - 1)].score;
            } else {
                firstNineScore = 501 - currentScore;
            }
            const avgFirstNine = totalDarts >= 9 ? (firstNineScore / 9) * 3 : 0;
            
            return {
                avgPerThree: Math.round(avgPerThree * 100) / 100,
                avgFirstNine: Math.round(avgFirstNine * 100) / 100
            };
        }

        function updateDisplay() {
            document.getElementById('currentScore').textContent = currentScore;
            document.getElementById('roundCounter').textContent = currentRound;
            document.getElementById('totalDarts').textContent = totalDarts;
            
            // P≈ôid√°no: Aktualizace pr≈Ømƒõr≈Ø
            const averages = calculateAverages();
            document.getElementById('avgPerThree').textContent = averages.avgPerThree;
            document.getElementById('avgFirstNine').textContent = averages.avgFirstNine;
            
            if (voiceMode === 'total') {
                const lastState = history[history.length - 1];
                document.getElementById('throwTotal').textContent = 
                    lastState.voiceTotal !== null ? `${lastState.voiceTotal}` : '-';
            } else {
                for (let i = 1; i <= maxThrows; i++) {
                    const throwElement = document.getElementById(`throw${i}`);
                    const throwValue = throws[i-1];
                    throwElement.textContent = throwValue ? 
                        `${throwValue.points} (${throwValue.base}√ó${throwValue.multiplier})` : 
                        '-';
                }
            }
            updateThrowIndicators();
        }

        function saveState() {
            history.push({
                score: currentScore,
                throws: [...throws],
                round: currentRound,
                totalDarts: totalDarts
            });
        }

        function toggleMultiplier(value) {
            if (voiceMode === 'none') {
                activeMultiplier = activeMultiplier === value ? 1 : value;
                document.getElementById('doubleBtn').classList.toggle('active-multiplier', activeMultiplier === 2);
                document.getElementById('tripleBtn').classList.toggle('active-multiplier', activeMultiplier === 3);
            }
        }

        function selectNumber(num) {
            if (voiceMode !== 'none') return;
            if (throws.length >= maxThrows) return;
            
            const points = num * activeMultiplier;
            throws.push({
                base: num,
                multiplier: activeMultiplier,
                points: points
            });
            currentScore -= points;
            totalDarts++;
            saveState();
            
            if (currentThrowIndex < maxThrows - 1) {
                currentThrowIndex++;
            }
            updateDisplay();
            updateThrowIndicators();
            
            if (activeMultiplier !== 1) {
                toggleMultiplier(activeMultiplier);
            }
            
            if (throws.length >= maxThrows) {
                setTimeout(() => {
                    throws = [];
                    currentRound++;
                    currentThrowIndex = 0;
                    saveState();
                    updateDisplay();
                    updateThrowIndicators();
                }, 2000);
            }
        }

        function undoLastThrow() {
            if (history.length > 1) {
                history.pop();
                const lastState = history[history.length - 1];
                currentScore = lastState.score;
                throws = lastState.throws ? [...lastState.throws] : [];
                currentRound = lastState.round;
                totalDarts = lastState.totalDarts;
                if (voiceMode === 'perThrow') {
                    currentThrowIndex = Math.max(0, throws.length);
                }
                updateDisplay();
            }
        }

        function resetGame() {
            currentScore = 501;
            throws = [];
            history = [{score: 501, throws: []}];
            activeMultiplier = 1;
            currentRound = 1;
            totalDarts = 0;
            currentThrowIndex = 0;
            setVoiceMode('none');
            toggleMultiplier(1);
            updateDisplay();
            updateThrowIndicators();
        }

        function setVoiceMode(mode) {
            voiceMode = mode;
            const container = document.querySelector('.container');
            const voiceTotalBtn = document.getElementById('voiceTotalBtn');
            const voicePerThrowBtn = document.getElementById('voicePerThrowBtn');
            
            container.classList.toggle('voice-total-active', mode === 'total');
            voiceTotalBtn.classList.toggle('voice-btn-active', mode === 'total');
            voicePerThrowBtn.classList.toggle('voice-btn-active', mode === 'perThrow');
            
            if (recognition) {
                recognition.stop();
                if (mode !== 'none') {
                    recognition.start();
                }
            }
            
            currentThrowIndex = 0;
            updateDisplay();
        }

        const numberGrid = document.getElementById('numberGrid');
        const numbers = [...Array(20).keys()].map(i => i + 1);
        numbers.push(25, 0);
        for (const i of numbers) {
            const btn = document.createElement('button');
            btn.textContent = i;
            btn.className = 'number-btn';
            btn.onclick = () => selectNumber(i);
            numberGrid.appendChild(btn);
        }

        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            
            recognition.lang = 'cs-CZ';
            recognition.continuous = true;
            recognition.interimResults = true;
            
            let processingTimeout = null;
            let isProcessing = false;
            
            recognition.onresult = function(event) {
                if (isProcessing) return;
                
                clearTimeout(processingTimeout);
                const transcript = event.results[event.results.length - 1][0].transcript;
                console.log('Pr≈Øbƒõ≈æn√Ω text:', transcript);
                
                processingTimeout = setTimeout(() => {
                    if (isProcessing) return;
                    isProcessing = true;
                    
                    console.log('Fin√°ln√≠ text:', transcript);
                    const number = convertSpokenNumberToCzech(transcript);
                    
                    if (number !== null) {
                        console.log('Odeƒç√≠t√°m:', number, 'od:', currentScore);
                        recognition.stop();
                        
                        if (voiceMode === 'total') {
                            addVoiceTotal(number);
                        } else if (voiceMode === 'perThrow') {
                            addScore(number);
                        }
                        
                        // Clear results and restart recognition after a delay
                        setTimeout(() => {
                            isProcessing = false;
                            if (voiceMode !== 'none') {
                                recognition.start();
                            }
                        }, 2000);
                    } else {
                        isProcessing = false;
                    }
                }, 1500);
            };

            recognition.onend = function() {
                // Only auto-restart if we're not in the middle of processing a number
                if (voiceMode !== 'none' && !isProcessing) {
                    setTimeout(() => {
                        recognition.start();
                    }, 100);
                }
            };

            document.getElementById('voiceTotalBtn').onclick = () => {
                setVoiceMode(voiceMode === 'total' ? 'none' : 'total');
            };
            
            document.getElementById('voicePerThrowBtn').onclick = () => {
                setVoiceMode(voiceMode === 'perThrow' ? 'none' : 'perThrow');
            };

        } else {
            console.log("Hlasov√© rozpozn√°v√°n√≠ nen√≠ podporov√°no");
            document.getElementById('voiceTotalBtn').style.display = 'none';
            document.getElementById('voicePerThrowBtn').style.display = 'none';
        }

        resetGame();
    </script>
</body>
</html>